// Enhanced JavaScript
const App = {
    isLoaded: false,
    currentSlide: 0,
    totalSlides: 3,
    scrollPosition: 0,
    isScrolling: false,
    countersAnimated: false,

    // Initialize all components
    init() {
        this.setupEventListeners();
        this.initPreloader();
        this.initCustomCursor();
        this.initScrollAnimations();
        this.initNavigation();
        this.initCourseFilters();
        this.initTestimonialSlider();
        this.initCounters();
        this.initForms();
        this.initProgressBars();
        this.updateOpenStatus();

        // Mark as loaded after initialization
        setTimeout(() => {
            this.isLoaded = true;
        }, 100);
    },

    // Event Listeners Setup
    setupEventListeners() {
        window.addEventListener('load', () => this.handleWindowLoad());
        window.addEventListener('scroll', () => this.handleScroll(), { passive: true });
        window.addEventListener('resize', () => this.handleResize(), { passive: true });
        document.addEventListener('DOMContentLoaded', () => this.handleDOMLoaded());

        // Performance optimization
        this.throttledScroll = this.throttle(this.handleScroll.bind(this), 16);
        window.addEventListener('scroll', this.throttledScroll, { passive: true });
    },

    // Utility: Throttle function for performance
    throttle(func, delay) {
        let timeoutId;
        let lastExecTime = 0;
        return function (...args) {
            const currentTime = Date.now();
            if (currentTime - lastExecTime > delay) {
                func.apply(this, args);
                lastExecTime = currentTime;
            } else {
                clearTimeout(timeoutId);
                timeoutId = setTimeout(() => {
                    func.apply(this, args);
                    lastExecTime = Date.now();
                }, delay - (currentTime - lastExecTime));
            }
        };
    },

    // Enhanced Preloader
    initPreloader() {
        const preloader = document.getElementById('preloader');
        if (!preloader) return;

        // Simulate loading progress
        let progress = 0;
        const loadingInterval = setInterval(() => {
            progress += Math.random() * 30;
            if (progress >= 100) {
                progress = 100;
                clearInterval(loadingInterval);
                this.hidePreloader();
            }
        }, 200);
    },

    hidePreloader() {
        const preloader = document.getElementById('preloader');
        if (preloader) {
            preloader.classList.add('loaded');
            document.body.style.overflow = 'visible';

            // Remove from DOM after animation
            setTimeout(() => {
                preloader.remove();
                this.triggerEntranceAnimations();
            }, 800);
        }
    },

    triggerEntranceAnimations() {
        // This function was not defined in the provided code snippet
        // You can add logic here to trigger entrance animations if needed
    },

    // Enhanced Custom Cursor
    initCustomCursor() {
        const dot = document.querySelector('.custom-cursor-dot');
        const outline = document.querySelector('.custom-cursor-outline');

        if (!dot || !outline) return;
        if (window.innerWidth <= 1024) return; // Disable on mobile

        let mouseX = 0, mouseY = 0;
        let dotX = 0, dotY = 0;
        let outlineX = 0, outlineY = 0;

        // Mouse tracking with smooth interpolation
        document.addEventListener('mousemove', (e) => {
            mouseX = e.clientX;
            mouseY = e.clientY;
        });

        // Smooth cursor animation
        const animateCursor = () => {
            // Smooth dot movement
            dotX += (mouseX - dotX) * 0.8;
            dotY += (mouseY - dotY) * 0.8;
            dot.style.left = dotX + 'px';
            dot.style.top = dotY + 'px';

            // Smooth outline movement
            outlineX += (mouseX - outlineX) * 0.2;
            outlineY += (mouseY - outlineY) * 0.2;
            outline.style.left = outlineX + 'px';
            outline.style.top = outlineY + 'px';

            requestAnimationFrame(animateCursor);
        };
        animateCursor();

        // Cursor hover effects
        document.querySelectorAll('a, button, [role="button"]').forEach(el => {
            el.addEventListener('mouseenter', () => {
                outline.classList.add('cursor-hover-link');
            });
            el.addEventListener('mouseleave', () => {
                outline.classList.remove('cursor-hover-link');
            });
        });

        document.querySelectorAll('p, h1, h2, h3, h4, h5, h6, span').forEach(el => {
            el.addEventListener('mouseenter', () => {
                outline.classList.add('cursor-hover-text');
            });
            el.addEventListener('mouseleave', () => {
                outline.classList.remove('cursor-hover-text');
            });
        });
    },

    // Enhanced Scroll Animations
    initScrollAnimations() {
        const observerOptions = {
            threshold: 0.1,
            rootMargin: '0px 0px -10% 0px'
        };

        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const delay = entry.target.dataset.delay || 0;
                    setTimeout(() => {
                        entry.target.classList.add('is-visible');
                        entry.target.classList.add('will-change-auto');
                        entry.target.classList.remove('will-change-transform');
                    }, delay);
                }
            });
        }, observerOptions);

        document.querySelectorAll('.animate-on-scroll').forEach(el => {
            el.classList.add('will-change-transform');
            observer.observe(el);
        });

        // Progressive timeline animation
        this.initTimelineProgress();
    },

    initTimelineProgress() {
        const progressBar = document.getElementById('timeline-progress');
        if (!progressBar) return;

        const timelineSteps = document.querySelectorAll('.methodology-step');
        const observer = new IntersectionObserver((entries) => {
            let visibleSteps = 0;
            entries.forEach(entry => {
                if (entry.isIntersecting) visibleSteps++;
            });

            const progressPercent = (visibleSteps / timelineSteps.length) * 100;
            progressBar.style.height = `${progressPercent}%`;
        }, { threshold: 0.5 });

        timelineSteps.forEach(step => observer.observe(step));
    },

    // Enhanced Navigation
    initNavigation() {
        const header = document.getElementById('main-header');
        const mobileToggle = document.getElementById('mobile-menu-toggle');
        const mobileMenu = document.getElementById('mobile-menu');
        const navLinks = document.querySelectorAll('.nav-link');

        // Smooth scrolling for navigation links
        navLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const targetId = link.getAttribute('href');
                const targetSection = document.querySelector(targetId);

                if (targetSection) {
                    this.scrollToSection(targetSection);
                    this.setActiveNavLink(link);

                    // Close mobile menu if open
                    if (mobileMenu && !mobileMenu.classList.contains('hidden')) {
                        this.toggleMobileMenu();
                    }
                }
            });
        });

        // Mobile menu toggle with enhanced animation
        if (mobileToggle && mobileMenu) {
            mobileToggle.addEventListener('click', () => {
                this.toggleMobileMenu();
            });
        }

        // Update active link on scroll
        this.initActiveNavTracking();
    },

    scrollToSection(target) {
        const headerHeight = document.getElementById('main-header').offsetHeight;
        const targetPosition = target.offsetTop - headerHeight - 20;

        window.scrollTo({
            top: targetPosition,
            behavior: 'smooth'
        });
    },

    toggleMobileMenu() {
        const mobileMenu = document.getElementById('mobile-menu');
        const mobileToggle = document.getElementById('mobile-menu-toggle');
        const icon = mobileToggle.querySelector('i');

        if (mobileMenu.classList.contains('hidden')) {
            mobileMenu.classList.remove('hidden');
            icon.className = 'ri-close-line transition-transform duration-300';
            document.body.style.overflow = 'hidden';
        } else {
            mobileMenu.classList.add('hidden');
            icon.className = 'ri-menu-4-line transition-transform duration-300';
            document.body.style.overflow = 'visible';
        }
    },

    setActiveNavLink(activeLink) {
        document.querySelectorAll('.nav-link').forEach(link => {
            link.classList.remove('active');
        });
        activeLink.classList.add('active');
    },

    initActiveNavTracking() {
        const sections = document.querySelectorAll('section[id]');
        const navLinks = document.querySelectorAll('.nav-link');

        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const targetLink = document.querySelector(`.nav-link[href="#${entry.target.id}"]`);
                    if (targetLink) {
                        this.setActiveNavLink(targetLink);
                    }
                }
            });
        }, { threshold: 0.5, rootMargin: '-20% 0px -60% 0px' });

        sections.forEach(section => observer.observe(section));
    },

    // Enhanced Course Filters
    initCourseFilters() {
        const filterBtns = document.querySelectorAll('.course-filter-btn');
        const courseCards = document.querySelectorAll('.course-card');

        filterBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                const filter = btn.dataset.filter;

                // Update active filter button
                filterBtns.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');

                // Filter courses with staggered animation
                this.filterCourses(filter, courseCards);
            });
        });
    },

    filterCourses(filter, cards) {
        cards.forEach((card, index) => {
            const category = card.dataset.category;
            const shouldShow = filter === 'all' || category === filter;

            if (shouldShow) {
                setTimeout(() => {
                    card.style.display = 'block';
                    card.style.opacity = '0';
                    card.style.transform = 'scale(0.8) translateY(20px)';

                    requestAnimationFrame(() => {
                        card.style.transition = 'all 0.5s cubic-bezier(0.4, 0, 0.2, 1)';
                        card.style.opacity = '1';
                        card.style.transform = 'scale(1) translateY(0)';
                    });
                }, index * 100);
            } else {
                card.style.transition = 'all 0.3s ease';
                card.style.opacity = '0';
                card.style.transform = 'scale(0.8) translateY(20px)';
                setTimeout(() => {
                    card.style.display = 'none';
                }, 300);
            }
        });
    },

    // Enhanced Testimonial Slider
    initTestimonialSlider() {
        const slider = document.querySelector('.testimonial-wrapper');
        const slides = document.querySelectorAll('.testimonial-slide');
        const prevBtn = document.querySelector('.slider-btn.prev');
        const nextBtn = document.querySelector('.slider-btn.next');
        const dots = document.querySelectorAll('.slider-dot');

        if (!slider || slides.length === 0) return;

        this.totalSlides = slides.length;

        // Navigation buttons
        prevBtn?.addEventListener('click', () => this.previousSlide());
        nextBtn?.addEventListener('click', () => this.nextSlide());

        // Dot navigation
        dots.forEach((dot, index) => {
            dot.addEventListener('click', () => this.goToSlide(index));
        });

        // Touch/swipe support
        this.initTouchSlider(slider);

        // Auto-play with pause on hover
        this.initAutoPlay();

        // Initialize first slide
        this.updateSlider();
    },

    nextSlide() {
        this.currentSlide = (this.currentSlide + 1) % this.totalSlides;
        this.updateSlider();
        this.resetAutoPlay();
    },

    previousSlide() {
        this.currentSlide = this.currentSlide === 0 ? this.totalSlides - 1 : this.currentSlide - 1;
        this.updateSlider();
        this.resetAutoPlay();
    },

    goToSlide(index) {
        this.currentSlide = index;
        this.updateSlider();
        this.resetAutoPlay();
    },

    updateSlider() {
        const slider = document.querySelector('.testimonial-wrapper');
        const dots = document.querySelectorAll('.slider-dot');

        if (slider) {
            slider.style.transform = `translateX(-${this.currentSlide * 100}%)`;
        }

        dots.forEach((dot, index) => {
            dot.classList.toggle('active', index === this.currentSlide);
        });
    },

    initTouchSlider(slider) {
        let startX = 0;
        let currentX = 0;
        let isDragging = false;

        slider.addEventListener('touchstart', (e) => {
            startX = e.touches[0].clientX;
            isDragging = true;
            this.pauseAutoPlay();
        }, { passive: true });

        slider.addEventListener('touchmove', (e) => {
            if (!isDragging) return;
            currentX = e.touches[0].clientX;
        }, { passive: true });

        slider.addEventListener('touchend', () => {
            if (!isDragging) return;
            isDragging = false;

            const diffX = startX - currentX;
            const threshold = 50;

            if (Math.abs(diffX) > threshold) {
                if (diffX > 0) {
                    this.nextSlide();
                } else {
                    this.previousSlide();
                }
            }

            this.resumeAutoPlay();
        });
    },

    initAutoPlay() {
        this.autoPlayInterval = setInterval(() => {
            if (!this.isScrolling) {
                this.nextSlide();
            }
        }, 5000);

        // Pause on hover
        const sliderContainer = document.getElementById('testimonial-slider');
        if (sliderContainer) {
            sliderContainer.addEventListener('mouseenter', () => this.pauseAutoPlay());
            sliderContainer.addEventListener('mouseleave', () => this.resumeAutoPlay());
        }
    },

    pauseAutoPlay() {
        if (this.autoPlayInterval) {
            clearInterval(this.autoPlayInterval);
            this.autoPlayInterval = null;
        }
    },

    resumeAutoPlay() {
        if (!this.autoPlayInterval) {
            this.initAutoPlay();
        }
    },

    resetAutoPlay() {
        this.pauseAutoPlay();
        this.resumeAutoPlay();
    },

    // Enhanced Counters Animation
    initCounters() {
        const counters = document.querySelectorAll('.stats-counter');

        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting && !this.countersAnimated) {
                    this.animateCounters(counters);
                    this.countersAnimated = true;
                }
            });
        }, { threshold: 0.5 });

        if (counters.length > 0) {
            observer.observe(counters[0]);
        }
    },

    animateCounters(counters) {
        counters.forEach(counter => {
            const target = parseInt(counter.dataset.count || counter.textContent);
            const duration = 2000;
            const startTime = performance.now();

            const updateCounter = (currentTime) => {
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);

                // Easing function for smooth animation
                const easeOutQuart = 1 - Math.pow(1 - progress, 4);
                const currentValue = Math.floor(easeOutQuart * target);

                counter.textContent = currentValue;

                if (progress < 1) {
                    requestAnimationFrame(updateCounter);
                } else {
                    counter.textContent = target;
                }
            };

            requestAnimationFrame(updateCounter);
        });
    },

    // Enhanced Forms
    initForms() {
        const newsletterForm = document.getElementById('newsletter-form');
        const statusDiv = document.getElementById('form-status');

        if (newsletterForm) {
            newsletterForm.addEventListener('submit', (e) => {
                e.preventDefault();
                this.handleNewsletterSubmission(newsletterForm, statusDiv);
            });
        }

        // Enhanced form validation
        this.initFormValidation();
    },

    handleNewsletterSubmission(form, statusDiv) {
        const email = form.querySelector('#newsletter-email').value;
        const submitBtn = form.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;

        // Validate email
        if (!this.isValidEmail(email)) {
            this.showFormStatus(statusDiv, 'Please enter a valid email address.', 'error');
            return;
        }

        // Show loading state
        submitBtn.innerHTML = '<i class="ri-loader-4-line animate-spin mr-2"></i>Processing...';
        submitBtn.disabled = true;

        // Simulate API call
        setTimeout(() => {
            this.showFormStatus(statusDiv, 'Thank you for subscribing! Check your email for confirmation.', 'success');
            form.reset();

            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        }, 1500);
    },

    showFormStatus(statusDiv, message, type) {
        if (!statusDiv) return;

        const className = type === 'success' ? 'text-green-400' : 'text-red-400';
        statusDiv.innerHTML = `<div class="${className} animate-pulse">${message}</div>`;

        setTimeout(() => {
            statusDiv.innerHTML = '';
        }, 5000);
    },

    isValidEmail(email) {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return emailRegex.test(email);
    },

    initFormValidation() {
        const inputs = document.querySelectorAll('.form-input');

        inputs.forEach(input => {
            input.addEventListener('blur', () => {
                this.validateInput(input);
            });

            input.addEventListener('input', () => {
                // Remove error state on input
                input.classList.remove('border-red-400');
            });
        });
    },

    validateInput(input) {
        const isValid = input.checkValidity();

        if (!isValid) {
            input.classList.add('border-red-400');
        } else {
            input.classList.remove('border-red-400');
            input.classList.add('border-green-400');
        }
    },

    // Enhanced Progress Bars and Interactive Elements
    initProgressBars() {
        // Back to top button
        const backToTopBtn = document.getElementById('back-to-top');
        if (backToTopBtn) {
            backToTopBtn.addEventListener('click', () => {
                window.scrollTo({
                    top: 0,
                    behavior: 'smooth'
                });
            });
        }
    },

    // Handle scroll events
    handleScroll() {
        if (!this.isLoaded) return;

        const scrollY = window.scrollY;
        const header = document.getElementById('main-header');
        const backToTopBtn = document.getElementById('back-to-top');

        // Header background on scroll
        if (header) {
            if (scrollY > 50) {
                header.classList.add('scrolled');
            } else {
                header.classList.remove('scrolled');
            }
        }

        // Back to top button visibility
        if (backToTopBtn) {
            if (scrollY > 300) {
                backToTopBtn.classList.add('show');
            } else {
                backToTopBtn.classList.remove('show');
            }
        }

        // Check if the user is scrolling
        this.isScrolling = true;
        clearTimeout(this.isScrollingTimeout);
        this.isScrollingTimeout = setTimeout(() => {
            this.isScrolling = false;
        }, 200);

        this.updateProgressBarsOnScroll();
    },

    // Missing functions added
    handleWindowLoad() {
        this.hidePreloader();
    },

    handleResize() {
        // Add logic to handle window resize if needed
    },

    handleDOMLoaded() {
        // This is where you would typically call App.init()
        // but it's being called by the preloader logic here.
        // It's good practice to call it here to ensure everything is ready.
        // App.init();
    },

    updateOpenStatus() {
        const openStatusElement = document.getElementById('open-status');
        if (openStatusElement) {
            const now = new Date();
            const day = now.getDay();
            const hour = now.getHours();

            // Check if it's Monday-Friday (1-5) and between 8 AM and 6 PM
            if (day >= 1 && day <= 5 && hour >= 8 && hour < 18) {
                openStatusElement.textContent = 'Open Now';
                openStatusElement.classList.add('text-green-500');
            } else {
                openStatusElement.textContent = 'Closed';
                openStatusElement.classList.add('text-red-500');
            }
        }
    },

    updateProgressBarsOnScroll() {
        // Add logic to update progress bars on scroll if needed
    }
};

document.addEventListener('DOMContentLoaded', () => {
    // Check for the existence of the App object before calling init.
    if (typeof App !== 'undefined') {
        App.init();
    }
});
